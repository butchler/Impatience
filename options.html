<html>
<head>
<title>TurtleWeb Options</title>

<script type="text/javascript" src="jquery.min.js"></script>

<script type="text/javascript">

$(function() {
   // Init blacklist/whitelist
   initListType();
   initSiteList();

   // Init timing
   initTiming('countdown');
   initTiming('allowed');
});


function initTiming(type)
{
   var minuteBox = $('#' + type + '-minutes');

   minuteBox.val(localStorage[type + 'Seconds'] / 60)

   var updateSeconds = function (e) {
      localStorage[type + 'Seconds'] = e.target.value * 60;
   };

   minuteBox.change(updateSeconds).blur(updateSeconds);
}


function initListType()
{
   $('#use-' + localStorage.listType)[0].checked = 'checked';

   $('input[name="list-type"]').change(function(e) {
      localStorage.listType = e.target.value;

      loadSites();
   });
}

function initSiteList()
{
   loadSites();

   // Init add site event
   $('#add-site').click(function(e) {
      var url = $('#url').val();
      addSite(getHostname(url));
   });
}
function loadSites()
{
   $('#site-list').empty();

   var sites = JSON.parse(localStorage[localStorage.listType]);

   sites.forEach(function(site) {
      $('#site-list').append('<li><span class="site">' + site + '</span> <a class="remove" onclick="removeSite(\'' + site + '\');">X</a></li>');
   });
}

function addSite(newSite)
{
   //removeSite(newSite);

   var sites = JSON.parse(localStorage[localStorage.listType]);
   sites.push(newSite);
   localStorage[localStorage.listType] = JSON.stringify(sites);

   loadSites();
}

function removeSite(removedSite)
{
   var sites = JSON.parse(localStorage[localStorage.listType]);
   sites = sites.filter(function(site) { return site !== removedSite; });
   localStorage[localStorage.listType] = JSON.stringify(sites);

   loadSites();
}


function getHostname(url)
{
   // Return anything after the protocol and www. that does not have slash in it (and hope that that's actually the domain name)
   var matches = url.match(new RegExp('^([^:]*://)?(www\.)?([^/]+)', 'i'));
   return (matches !== null) ? matches[3] : url;
}

</script>

</head>

<body>
<div id="options">

   <h2>Turtled sites</h2>
   <p>Control which sites you want to be "turtled," meaning that you have to wait before you can use them.</p>

   <p>
      <input type="radio" name="list-type" value="blacklist" id="use-blacklist" /> <label for="use-blacklist">Use blacklist</label>
      <input type="radio" name="list-type" value="whitelist" id="use-whitelist" /> <label for="use-whitelist">Use whitelist</label>
   </p>

   <ul id="site-list"></ul>
   <form id="controls">
      URL: <input type="text" id="url" /> <input type="submit" id="add-site" value="Add" />
   </form>

   <p>Make me wait <input id="countdown-minutes" type="number" /> minutes before I can use each turtled site.</p>
   <p>Allow me to use each turtled site for <input id="allowed-minutes" type="number" /> minutes after waiting.</p>

</div>
</body>
</html>
