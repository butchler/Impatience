<html>
<head>
<script language="javascript">

// Contains information about any currently running countdowns
var countdowns = {};

// Settings for testing
localStorage.turtledSites = JSON.stringify(['facebook.com']);   // The list of "turtled" sites
localStorage.countdownSeconds = '5';   // The number of seconds that you have to wait before using a turtled site
localStorage.allowedSeconds = '10';     // The number of seconds that you can use a turtled site before you have to wait again

initLocalStorage();
addEventListeners();


// Initialize localStorage variables if they haven't been initialized yet
function initLocalStorage()
{
   // The list of "turtled" sites
   if (localStorage.blacklist == undefined)
      localStorage.blacklist = JSON.stringify([]);
   // The number of seconds that you have to wait before using a turtled site
   if (localStorage.countdownSeconds == undefined)
      localStorage.countdownSeconds = '300';
   // The number of seconds that you can use a turtled site before you have to wait again
   if (localStorage.allowedSeconds == undefined)
      localStorage.allowedSeconds = '600';
}

function addEventListeners()
{
   // When a tab is created or its URL is updated, check if the new URL is a turtled website, and if so start a countdown
   chrome.tabs.onCreated.addListener(function (tab) {
      if (isTurtled(tab.url))
      {
         startCountdownForTab(tab.url, tab.id);
      }
   });
   chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
      if (changeInfo.url != undefined && isTurtled(changeInfo.url))
      {
         startCountdownForTab(changeInfo.url, tabId);
      }
   });

   // When a countdown tab is removed, stop the countdown
   chrome.tabs.onRemoved.addListener(function (tabId, removeInfo) {
      if (countdowns[tabId] != undefined)
      {
         stopCountdownForTab(tabId);
      }
   });

   // This request is used by the countdown page to get the number of seconds left in the countdown
   chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
      if (request.request == 'getCountdownInfo')
      {
         sendResponse(getCountdownByTab(request.tabId));
      }
   });
}


function isTurtled(url, tabId)
{
   var host = getHostname(url);
   var turtledSites = JSON.parse(localStorage.turtledSites);

   return (host in turtledSites);
}

function startCountdownForTab(url, tabId)
{
   getCountdownByHost(getHostname(url)).addTab(tabId, url);
}

function stopCountdownForTab(tabId)
{
   getCountdownByTab(tabId).removeTab(tabId);
}

function getCountdownByHost(host)
{
   return (countdown[host] || new Countdown(host));
}

function getCountdownByTab(tabId)
{
   for (host in countdowns)
   {
      var countdown = countdowns[host];
      var tabIds = countdown.tabs.map(function(tab) { return tab.id; });

      if (tabId in tabIds)
         return countdown;
   }
}


function Countdown(host)
{
   this.host = host;
   this.tabs = []
   this.countdownFinished = false;

   this.startCountdown(parseInt(localStorage.countdownSeconds));

   countdowns[host] = this;
}

Countdown.prototype.startCountdown = function(seconds) {
   this.secondsLeft = seconds;

   this.coutdownInterval = setInterval(this.updateCountdown, 1000);
}

Countdown.prototype.updateCountdown = function() {
   this.secondsLeft -= 1;

   if (this.secondsLeft <= 0)
      this.stopCountdown();
}

Countdown.prototype.stopCountdown = function() {
   clearInterval(this.countdownInterval);

   // Redirect all tabs back to their original URLs
   this.tabs.forEach(function (tab) {
      chrome.tabs.get(tab.id, function(chromeTab) {
         tab.url = tab.originalUrl;
         tab.originalUrl = chromeTab.url;

         chrome.tabs.update(tab.id, { url: tab.url });
      });
   });

   this.countdownFinished = !this.countdownFinished;

   this.startCountdown(parseInt((this.countdownFinished) ? localStorage.allowedSeconds : localStorage.countdownSeconds));
}

Countdown.prototype.addTab = function(tabId, url) {
   this.tabs.push({ id: tabId, originalUrl: url, url: chrome.extension.getURL('countdown.html') });

   chrome.tabs.update(tab.id, { url: tab.url });
}

Countdown.prototype.removeTab = function(tabId) {
   this.tabs = this.tabs.filter(function(tab) { return tab.id != tabId; });

   if (this.tabs.length == 0)
   {
      this.stopCountdown();

      delete countdowns[this.host];
   }
}

</script>
</head>
</html>
