<html>
<head>
<script language="javascript">

// Contains information about any currently running countdowns
var countdowns = {};
// List of turtled sites that have been temporarily unblocked after finishing the countdown
var unturtledSites = [];

// Settings for testing
localStorage.turtledSites = JSON.stringify(['facebook.com']);   // The list of "turtled" sites
localStorage.countdownSeconds = '10';   // The number of seconds that you have to wait before using a turtled site
localStorage.allowedSeconds = '10';     // The number of seconds that you can use a turtled site before you have to wait again

initLocalStorage();
addEventListeners();


// Initialize localStorage variables if they haven't been initialized yet
function initLocalStorage()
{
  if (localStorage.blacklist == undefined)
    // The list of "turtled" sites
    localStorage.blacklist = JSON.stringify([]);
  if (localStorage.countdownSeconds == undefined)
    // The number of seconds that you have to wait before using a turtled site
    localStorage.countdownSeconds = '300';
  if (localStorage.allowedSeconds == undefined)
    // The number of seconds that you can use a turtled site before you have to wait again
    localStorage.allowedSeconds = '600';
}

function addEventListeners()
{
  // When a tab is created or its URL is updated, check if the new URL is a turtled website, and if so start a countdown
  chrome.tabs.onCreated.addListener(function (tab) {
    if (isTurtled(tab.url, tab.id))
    {
      startCountdown(tab.url, tab.id);
    }
  });
  chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
    if (changeInfo.url != undefined && isTurtled(changeInfo.url, tabId))
    {
      startCountdown(changeInfo.url, tabId);
    }
  });

  // When a countdown tab is removed, stop the countdown
  chrome.tabs.onRemoved.addListener(function (tabId, removeInfo) {
    if (countdowns[tabId] != undefined)
    {
      clearInterval(countdowns[tabId].interval);

      delete countdowns[tabId];
    }
  });

  // This request is used by the countdown page to get the number of seconds left in the countdown
  chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    if (request.request == 'getCountdownInfo')
    {
      sendResponse(countdowns[request.tabId]);
    }
  });
}


// Check if a given page is turtled/blacklist
function isTurtled(url, tabId)
{
  var host = getHostname(url);
  var turtledSites = JSON.parse(localStorage.turtledSites);

  if (turtledSites.contains(host))
  {
    // The site is temporarily unblocked
    if (unturtledSites.contains(host))
    {
      return false;
    }

    return true;
  }

  return false;
}

// Start countdown and redirect to countdown page
function startCountdown(url, tabId)
{
  var host = getHostname(url);

  // First, check if there is a countdown for the given site going on already
  for (otherTab in countdowns)
  {
    if (countdowns[otherTab].host == host)
    {
      // There is already a countdown going on for this site, just use the exisiting countdown and redirect to countdown page
      countdowns[tabId] = countdowns[otherTab];

      // Redirect
      chrome.tabs.update(tabId, { 'url': chrome.extension.getURL('countdown.html') });

      return;
    }
  }

  // Start countdown
  var interval = setInterval(function () { updateCountdown(tabId); }, 1000);
  countdowns[tabId] = { 'url': url, 'host': host, 'secondsLeft': parseInt(localStorage.countdownSeconds), 'interval': interval };

  // Redirect
  chrome.tabs.update(tabId, { 'url': chrome.extension.getURL('countdown.html') });
}

function updateCountdown(tabId)
{
  // Countdown every second
  countdowns[tabId].secondsLeft -= 1;

  // Stop countdown when count reaches zero
  if (countdowns[tabId].secondsLeft <= 0)
  {
    stopCountdown(tabId);
  }
}

// Redirect back to original page
function stopCountdown(tabId)
{
  // Stop countdown
  clearInterval(countdowns[tabId].interval);

  unturtle(countdowns[tabId].host);

  // Redirect
  chrome.tabs.update(tabId, { 'url': countdowns[tabId].url });

  // Remove countdown information
  delete countdowns[tabId];
}


// Temporarily unblock the given site
function unturtle(host)
{
  // Add to list of temporarily unturtled sites
  unturtledSites.push(host);

  // Remove the site from the unturtled list after localStorage.allowedSeconds seconds
  setTimeout(function() { returtle(host); }, parseInt(localStorage.allowedSeconds) * 1000);
}

// After the allowed usage time is over, remove the given site from the unturtled list
function returtle(host)
{
  unturtledSites.remove(host);
}

// Get the hostname/site name of a given URL
// For example, turn 'http://www.facebook.com/OrigamiClubatUCF' into just 'facebook.com'
function getHostname(url)
{
  var matches = url.match(new RegExp('^([^:]*://)?(www\.)?([^/]*)', 'i'));
  return matches[3];   //                    matches[3] = ([^/]*)
}


// Some utility functions for arrays
Array.prototype.contains = function (x) {
  return (this.indexOf(x) >= 0);
};
Array.prototype.remove = function(x) {
  delete this[this.indexOf(x)];
};

</script>
</head>
</html>
