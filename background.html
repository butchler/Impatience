<html>
<script language="javascript">

// Initialize localStorage variables if they haven't been initialized yet
/*if (localStorage.blacklist == undefined)
   localStorage.blacklist = JSON.stringify([]);
if (localStorage.countdownSeconds == undefined)
   localStorage.countdownSeconds = '300';
if (localStorage.unblockedSeconds == undefined)
   localStorage.unblockedSeconds = '300';*/

// Settings for testing
localStorage.blacklist = JSON.stringify(['facebook.com']);
localStorage.countdownSeconds = '5';
localStorage.unblockedTime = '10';

var countdowns = {};
var unblocked = [];

chrome.tabs.onCreated.addListener(function (tab) {
  if (isBlacklisted(tab.url, tab.id))
  {
    startCountdown(tab.url, tab.id);
  }
});

chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
  if (changeInfo.url != undefined && isBlacklisted(changeInfo.url, tabId))
  {
    startCountdown(changeInfo.url, tabId);
  }
});

chrome.tabs.onRemoved.addListener(function (tabId, removeInfo) {
  if (countdowns[tabId] != undefined)
  {
    clearInterval(countdowns[tabId].interval);
  }

  delete countdowns[tabId];
});

Array.prototype.contains = function (x) {
  return (this.indexOf(x) >= 0);
};

function isBlacklisted(url, tabId)
{
  var host = getHostname(url);
  var blacklist = JSON.parse(localStorage.blacklist);

  if (blacklist.contains(host))
  {
    if (tabs[tabId] != undefined && unblocked.contains(countdowns[tabId].host))
    {
      return false;
    }

    return true;
  }

  return false;
}

// Start countdown and redirect to countdown page
function startCountdown(url, tabId)
{
  // Start countdown
  var interval = setInterval(function () { doCountdown(tabId); }, 1000);
  countdowns[tabId] = { 'url': url, 'host': getHostname(url), 'secondsLeft': parseInt(localStorage.countdownSeconds), 'interval': interval };

  // Redirect
  chrome.tabs.update(tabId, { 'url': chrome.extension.getURL('countdown.html') });
}

function doCountdown(tabId)
{
  // Countdown every second
  countdowns[tabId].secondsLeft -= 1;

  // Stop countdown when count reaches zero
  if (countdowns[tabId].secondsLeft <= 0)
  {
    stopCountdown(tabId);
  }
}

// Redirect back to original page
function stopCountdown(tabId)
{
  // Stop countdown
  clearInterval(countdowns[tabId].interval);

  unblock(countdowns[tabId.host]);

  // Redirect
  chrome.tabs.update(tabId, { 'url': countdowns[tabId].url });
}

function unblock(host)
{
  unblocked.push(host);

  setTimeout(function() { reblock(countdowns[tabId].host); }, parseInt(localStorage.unblockedSeconds) * 1000);
}

Array.prototype.remove = function(x) {
  delete this[this.indexOf(x)];
};

function reblock(host)
{
  unblocked.remove(host);
}

function getHostname(url)
{
  var matches = url.match(new RegExp('^(https?://)?(www\.)?([^/]*)', 'i'));
  //                                          matches[3] = ([^/]*)
  return matches[3];
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if (request.request == 'getCountdownInfo')
  {
    sendResponse(countdowns[request.tabId]);
  }
});

</script>
</html>
